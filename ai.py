from core.gamedata import *
import sys

example_gamestate = GameState(
    level=1,
    round=1,
    pacman_score=0,
    ghosts_score=0,
    pacman_skill_status=[0, 0, 0, 0],
    pacman_pos=np.array([36, 1]),
    ghosts_pos=np.array([np.array([36, 36]), np.array([1, 36]), np.array([1, 1])]),
    board_size=38,
    board=[
        [
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
        ],
        [
            0,
            1,
            2,
            1,
            5,
            2,
            1,
            2,
            2,
            2,
            2,
            7,
            1,
            6,
            2,
            2,
            2,
            3,
            2,
            2,
            2,
            2,
            5,
            1,
            2,
            1,
            2,
            5,
            1,
            2,
            2,
            1,
            1,
            2,
            1,
            3,
            2,
            0,
        ],
        [
            0,
            1,
            2,
            2,
            2,
            0,
            2,
            4,
            2,
            2,
            3,
            2,
            2,
            2,
            0,
            2,
            2,
            2,
            2,
            2,
            2,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            1,
            2,
            1,
            1,
            2,
            1,
            1,
            1,
            2,
            0,
        ],
        [
            0,
            2,
            1,
            6,
            2,
            0,
            1,
            1,
            5,
            6,
            2,
            1,
            2,
            2,
            0,
            7,
            3,
            7,
            2,
            2,
            1,
            2,
            4,
            2,
            1,
            2,
            0,
            1,
            7,
            0,
            0,
            0,
            5,
            2,
            4,
            1,
            2,
            0,
        ],
        [
            0,
            1,
            2,
            1,
            1,
            0,
            2,
            2,
            2,
            2,
            2,
            7,
            1,
            2,
            0,
            3,
            3,
            1,
            2,
            1,
            2,
            0,
            2,
            2,
            1,
            3,
            0,
            2,
            2,
            0,
            1,
            5,
            1,
            2,
            5,
            7,
            2,
            0,
        ],
        [
            0,
            6,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            6,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            1,
            1,
            2,
            1,
            4,
            2,
            0,
            0,
            1,
            2,
            0,
            2,
            1,
            2,
            3,
            2,
            1,
            2,
            0,
        ],
        [
            0,
            5,
            6,
            1,
            1,
            0,
            2,
            3,
            2,
            2,
            2,
            7,
            1,
            1,
            0,
            2,
            2,
            2,
            2,
            3,
            2,
            1,
            2,
            0,
            2,
            2,
            0,
            2,
            2,
            0,
            2,
            5,
            2,
            6,
            0,
            5,
            2,
            0,
        ],
        [
            0,
            2,
            5,
            2,
            7,
            0,
            4,
            4,
            1,
            1,
            2,
            1,
            4,
            2,
            0,
            2,
            1,
            2,
            2,
            2,
            2,
            1,
            1,
            7,
            2,
            1,
            0,
            1,
            1,
            0,
            1,
            2,
            1,
            2,
            1,
            2,
            2,
            0,
        ],
        [
            0,
            6,
            1,
            2,
            1,
            0,
            7,
            2,
            6,
            6,
            2,
            2,
            3,
            1,
            0,
            4,
            2,
            4,
            2,
            7,
            1,
            1,
            2,
            2,
            2,
            5,
            2,
            2,
            5,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            2,
            0,
        ],
        [
            0,
            2,
            6,
            2,
            2,
            2,
            2,
            4,
            7,
            1,
            1,
            1,
            3,
            6,
            1,
            2,
            1,
            2,
            2,
            2,
            2,
            1,
            2,
            7,
            2,
            2,
            2,
            1,
            2,
            1,
            2,
            2,
            4,
            2,
            3,
            1,
            2,
            0,
        ],
        [
            0,
            1,
            1,
            2,
            2,
            1,
            2,
            2,
            2,
            2,
            1,
            2,
            2,
            2,
            2,
            7,
            2,
            2,
            2,
            2,
            2,
            1,
            1,
            2,
            1,
            2,
            1,
            2,
            1,
            5,
            2,
            2,
            1,
            2,
            1,
            2,
            2,
            0,
        ],
        [
            0,
            6,
            0,
            0,
            0,
            3,
            0,
            0,
            0,
            7,
            2,
            2,
            4,
            2,
            0,
            6,
            2,
            3,
            2,
            7,
            2,
            2,
            2,
            0,
            2,
            2,
            6,
            5,
            4,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            0,
        ],
        [
            0,
            2,
            0,
            0,
            7,
            1,
            5,
            3,
            0,
            6,
            5,
            2,
            1,
            1,
            0,
            2,
            5,
            2,
            2,
            2,
            7,
            2,
            2,
            0,
            4,
            5,
            2,
            7,
            7,
            0,
            2,
            2,
            1,
            1,
            0,
            0,
            2,
            0,
        ],
        [
            0,
            2,
            0,
            2,
            0,
            2,
            7,
            6,
            0,
            3,
            3,
            2,
            1,
            2,
            0,
            5,
            1,
            1,
            2,
            1,
            2,
            4,
            2,
            0,
            3,
            2,
            2,
            6,
            2,
            0,
            2,
            2,
            2,
            0,
            2,
            0,
            2,
            0,
        ],
        [
            0,
            7,
            3,
            1,
            4,
            3,
            2,
            2,
            0,
            2,
            1,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            6,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            2,
            3,
            7,
            7,
            2,
            2,
            2,
            3,
            2,
            0,
        ],
        [
            0,
            1,
            0,
            2,
            2,
            2,
            0,
            2,
            0,
            2,
            2,
            2,
            5,
            1,
            0,
            2,
            2,
            5,
            2,
            1,
            2,
            4,
            2,
            0,
            2,
            1,
            2,
            2,
            4,
            0,
            2,
            0,
            5,
            3,
            2,
            0,
            2,
            0,
        ],
        [
            0,
            2,
            0,
            2,
            2,
            2,
            4,
            0,
            0,
            1,
            2,
            2,
            2,
            1,
            0,
            1,
            3,
            2,
            2,
            2,
            1,
            7,
            4,
            0,
            1,
            1,
            2,
            1,
            2,
            0,
            0,
            2,
            1,
            2,
            2,
            0,
            2,
            0,
        ],
        [
            0,
            1,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            1,
            6,
            2,
            2,
            2,
            0,
            2,
            7,
            2,
            2,
            2,
            2,
            2,
            2,
            0,
            2,
            1,
            3,
            1,
            1,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            0,
        ],
        [
            0,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            0,
        ],
        [
            0,
            1,
            2,
            1,
            2,
            6,
            1,
            2,
            2,
            5,
            2,
            1,
            5,
            1,
            2,
            1,
            1,
            2,
            2,
            6,
            2,
            1,
            3,
            2,
            2,
            2,
            7,
            1,
            2,
            2,
            2,
            2,
            2,
            1,
            2,
            6,
            2,
            0,
        ],
        [
            0,
            3,
            6,
            2,
            2,
            2,
            5,
            6,
            2,
            2,
            2,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            5,
            2,
            2,
            2,
            1,
            2,
            2,
            6,
            1,
            6,
            7,
            6,
            2,
            1,
            2,
            2,
            1,
            2,
            0,
        ],
        [
            0,
            2,
            0,
            2,
            2,
            0,
            6,
            2,
            1,
            2,
            2,
            0,
            2,
            1,
            1,
            1,
            0,
            0,
            2,
            1,
            0,
            2,
            2,
            2,
            2,
            2,
            2,
            1,
            2,
            0,
            3,
            6,
            1,
            2,
            1,
            2,
            2,
            0,
        ],
        [
            0,
            1,
            0,
            2,
            2,
            2,
            2,
            2,
            3,
            3,
            1,
            0,
            7,
            2,
            3,
            0,
            2,
            0,
            2,
            1,
            0,
            2,
            2,
            2,
            1,
            2,
            2,
            1,
            1,
            0,
            0,
            2,
            2,
            3,
            2,
            1,
            2,
            0,
        ],
        [
            0,
            1,
            0,
            7,
            4,
            0,
            2,
            3,
            6,
            2,
            2,
            3,
            2,
            7,
            7,
            1,
            2,
            3,
            2,
            2,
            0,
            2,
            2,
            5,
            0,
            2,
            2,
            1,
            3,
            0,
            7,
            2,
            2,
            2,
            0,
            2,
            2,
            0,
        ],
        [
            0,
            2,
            0,
            1,
            4,
            2,
            6,
            2,
            2,
            1,
            2,
            0,
            2,
            0,
            2,
            1,
            1,
            0,
            2,
            2,
            0,
            2,
            2,
            0,
            2,
            2,
            2,
            2,
            3,
            0,
            0,
            2,
            2,
            4,
            1,
            2,
            2,
            0,
        ],
        [
            0,
            2,
            0,
            1,
            2,
            0,
            3,
            7,
            7,
            2,
            2,
            0,
            0,
            2,
            1,
            2,
            2,
            0,
            2,
            2,
            0,
            6,
            0,
            2,
            2,
            2,
            2,
            2,
            2,
            0,
            2,
            2,
            6,
            2,
            4,
            2,
            2,
            0,
        ],
        [
            0,
            6,
            0,
            0,
            0,
            0,
            0,
            0,
            1,
            1,
            1,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            2,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            2,
            1,
            0,
            0,
            0,
            0,
            0,
            0,
            1,
            2,
            0,
        ],
        [
            0,
            2,
            2,
            1,
            2,
            6,
            2,
            4,
            4,
            7,
            7,
            2,
            4,
            2,
            2,
            2,
            2,
            6,
            2,
            5,
            1,
            2,
            5,
            2,
            1,
            2,
            2,
            7,
            4,
            2,
            2,
            4,
            1,
            1,
            2,
            7,
            2,
            0,
        ],
        [
            0,
            2,
            6,
            1,
            2,
            2,
            2,
            2,
            2,
            5,
            2,
            2,
            7,
            1,
            1,
            1,
            2,
            1,
            2,
            1,
            1,
            2,
            2,
            1,
            7,
            2,
            1,
            1,
            1,
            1,
            1,
            2,
            1,
            3,
            2,
            2,
            2,
            0,
        ],
        [
            0,
            2,
            3,
            0,
            0,
            0,
            0,
            0,
            0,
            1,
            1,
            1,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            2,
            2,
            1,
            2,
            0,
            1,
            4,
            1,
            2,
            1,
            1,
            2,
            4,
            1,
            1,
            2,
            3,
            2,
            0,
        ],
        [
            0,
            2,
            2,
            1,
            6,
            2,
            1,
            0,
            0,
            2,
            2,
            1,
            1,
            7,
            0,
            7,
            0,
            0,
            2,
            2,
            2,
            2,
            3,
            0,
            7,
            2,
            7,
            1,
            1,
            0,
            2,
            2,
            0,
            3,
            2,
            2,
            2,
            0,
        ],
        [
            0,
            3,
            2,
            5,
            2,
            1,
            4,
            1,
            0,
            6,
            2,
            2,
            1,
            0,
            2,
            2,
            2,
            0,
            2,
            2,
            2,
            2,
            3,
            0,
            2,
            2,
            2,
            1,
            7,
            0,
            2,
            4,
            0,
            1,
            2,
            1,
            2,
            0,
        ],
        [
            0,
            2,
            2,
            2,
            1,
            6,
            2,
            2,
            0,
            1,
            2,
            2,
            1,
            1,
            1,
            1,
            2,
            0,
            2,
            1,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            1,
            2,
            0,
            2,
            2,
            0,
            1,
            2,
            1,
            2,
            0,
        ],
        [
            0,
            2,
            2,
            6,
            2,
            6,
            6,
            0,
            0,
            3,
            4,
            2,
            2,
            4,
            4,
            1,
            2,
            0,
            2,
            2,
            2,
            2,
            2,
            0,
            2,
            2,
            2,
            2,
            3,
            0,
            2,
            2,
            2,
            4,
            2,
            2,
            2,
            0,
        ],
        [
            0,
            5,
            2,
            2,
            2,
            2,
            3,
            0,
            0,
            7,
            2,
            2,
            2,
            1,
            2,
            1,
            2,
            0,
            2,
            2,
            2,
            1,
            2,
            0,
            2,
            2,
            1,
            1,
            1,
            0,
            4,
            2,
            1,
            2,
            2,
            5,
            2,
            0,
        ],
        [
            0,
            2,
            2,
            2,
            2,
            1,
            2,
            1,
            1,
            5,
            6,
            3,
            6,
            3,
            6,
            7,
            3,
            1,
            2,
            1,
            5,
            5,
            3,
            0,
            2,
            2,
            2,
            1,
            2,
            0,
            0,
            0,
            0,
            0,
            0,
            2,
            2,
            0,
        ],
        [
            0,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            2,
            0,
        ],
        [
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
        ],
    ],
    portal_available=False,
    portal_coord=np.array([20, 20]),
)

import random
from typing import List
from collections import deque
import numpy as np

def parse(x: tuple):
    if x == (0, 0):
        return Direction.STAY.value
    if x == (1, 0):
        return Direction.UP.value
    if x == (-1, 0):
        return Direction.DOWN.value
    if x == (0, 1):
        return Direction.RIGHT.value
    if x == (0, -1):
        return Direction.LEFT.value
    
    
class GhostAI:
    def __init__(self):
        self.position_history = {0: [], 1: [], 2: []}
        self.history_length = 5

    def manhattan_distance(self, pos1, pos2):
        return abs(pos1[0] - pos2[0]) + abs(pos1[1] - pos2[1])

    def get_valid_moves(self, pos, game_state):
        valid_moves = []
        directions = [
            ([1, 0], 1),  # UP
            ([-1, 0], 3),  # DOWN
            ([0, -1], 2),  # LEFT
            ([0, 1], 4),  # RIGHT
        ]

        for direction, move_value in directions:
            new_pos = [pos[0] + direction[0], pos[1] + direction[1]]
            if (
                0 <= new_pos[0] < game_state.board_size
                and 0 <= new_pos[1] < game_state.board_size
                and game_state.board[new_pos[0]][new_pos[1]] != 0
            ):
                valid_moves.append((new_pos, move_value))
        return valid_moves

    def a_star_search(self, start: np.ndarray, goal: np.ndarray, game_state: GameState):
        open_set = set()
        open_set.add(tuple(start))
        came_from = {}

        g_score = {tuple(start): 0}
        f_score = {tuple(start): self.manhattan_distance(start, goal)}

        while open_set:
            current = min(open_set, key=lambda x: f_score.get(x, float("inf")))
            if current == tuple(goal):
                path = []
                while current in came_from:
                    path.append(current)
                    current = came_from[current]
                path.reverse()
                return path

            open_set.remove(current)
            for direction, _ in self.get_valid_moves(list(current), game_state):
                neighbor = tuple(direction)
                tentative_g_score = g_score[current] + 1

                if tentative_g_score < g_score.get(neighbor, float("inf")):
                    came_from[neighbor] = current
                    g_score[neighbor] = tentative_g_score
                    f_score[neighbor] = tentative_g_score + self.manhattan_distance(
                        neighbor, goal
                    )
                    if neighbor not in open_set:
                        open_set.add(neighbor)

        return []

    def calculate_stagnation_penalty(self, new_pos, ghost_id):
        if not self.position_history[ghost_id]:
            return 0
        repeat_count = sum(
            1
            for pos in self.position_history[ghost_id]
            if pos[0] == new_pos[0] and pos[1] == new_pos[1]
        )
        return repeat_count * 2

    def update_history(self, ghost_id, new_pos):
        self.position_history[ghost_id].append(new_pos)
        if len(self.position_history[ghost_id]) > self.history_length:
            self.position_history[ghost_id].pop(0)

    def choose_moves(self, game_state: GameState):
        moves = []
        pacman_pos = game_state.pacman_pos

        for ghost_id in range(3):
            current_pos = game_state.ghosts_pos[ghost_id]
            valid_moves = self.get_valid_moves(current_pos, game_state)

            if not valid_moves:
                moves.append(Direction.STAY.value)
                continue

            # 计算到吃豆人的距离
            a_star_path = self.a_star_search(current_pos, pacman_pos, game_state)
            distance_to_pacman = len(a_star_path) if a_star_path else float("inf")

            # 如果距离很近（比如小于5），直接追击
            if distance_to_pacman <= 5:
                best_move = tuple(a_star_path[0], parse((a_star_path[0][0] - current_pos[0], a_star_path[0][1] - current_pos[1])))
            else:
                # 距离较远时使用更复杂的策略
                target_pos = pacman_pos
                # 不同幽灵的策略
                if ghost_id == 0:
                    # 通过A*寻路算法直接追击
                    pass
                elif ghost_id == 1:
                    # 预测吃豆人移动方向
                    dx = pacman_pos[0] - current_pos[0]
                    dy = pacman_pos[1] - current_pos[1]
                    predicted_x = pacman_pos[0] + (1 if dx > 0 else -1 if dx < 0 else 0)
                    predicted_y = pacman_pos[1] + (1 if dy > 0 else -1 if dy < 0 else 0)
                    if (
                        0 <= predicted_x < game_state.board_size
                        and 0 <= predicted_y < game_state.board_size
                        and game_state.board[predicted_x][predicted_y] != 0
                    ):
                        target_pos = [predicted_x, predicted_y]
                else:
                    # 尝试切断路线
                    other_ghost = game_state.ghosts_pos[0]  # 使用第一个幽灵作为参考
                    dx = pacman_pos[0] - other_ghost[0]
                    dy = pacman_pos[1] - other_ghost[1]
                    intercept_x = pacman_pos[0] + (1 if dx > 0 else -1 if dx < 0 else 0)
                    intercept_y = pacman_pos[1] + (1 if dy > 0 else -1 if dy < 0 else 0)
                    intercept_x = max(0, min(intercept_x, game_state.board_size - 1))
                    intercept_y = max(0, min(intercept_y, game_state.board_size - 1))
                    if game_state.board[intercept_x][intercept_y] != 0:
                        target_pos = [intercept_x, intercept_y]

                path = self.a_star_search(current_pos, target_pos, game_state)
                
                if path:
                    best_move = (path[0], parse((path[0][0] - current_pos[0], path[0][1] - current_pos[1])))
                else:
                    best_move = min(
                        valid_moves,
                        key=lambda x: self.manhattan_distance(x[0], pacman_pos),
                    )

            self.update_history(ghost_id, best_move[0])
            moves.append(best_move[1])

        return moves


ai_func = GhostAI().choose_moves
# print(ai_func(example_gamestate))
__all__ = ["ai_func"]
